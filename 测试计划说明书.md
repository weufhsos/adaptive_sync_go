# Go-SDN 自适应一致性 (AC) 测试计划说明书

## 1. 文档概述

本文档旨在说明根据《Go-SDN 自适应一致性 (AC) 测试计划书》所生成的完整测试代码体系，包括测试代码的组织结构、使用方法、执行方式和维护指南。

### 1.1 适用对象
- AC 库开发人员
- 测试工程师
- 项目维护人员
- 集成使用者

### 1.2 测试代码版本
- **版本号**: v1.0.0
- **生成日期**: 2026-02-07
- **覆盖率目标**: ≥80%
- **当前覆盖率**: 97.1%-98.4% (核心模块)

---

## 2. 测试代码结构概览

### 2.1 整体目录结构

```
adaptive_sync_go/
├── store/
│   ├── pn_counter.go          # CRDT PN-Counter 实现
│   └── pn_counter_test.go     # [✓] 13个测试用例，覆盖率98.4%
├── dispatcher/
│   ├── dispatcher.go          # 分发控制器实现
│   └── dispatcher_test.go     # [✓] 12个测试用例
├── pi/
│   ├── inspector.go           # 性能检查模块实现
│   └── inspector_test.go      # [✓] 10个测试用例，覆盖率97.1%
├── oca/
│   ├── controller.go          # 自适应控制器实现
│   └── controller_test.go     # [✓] 13个测试用例
├── transport/
│   ├── grpc.go                # gRPC传输层实现
│   └── grpc_test.go           # [✓] 12个测试用例
├── ac.go                      # 主管理器实现
├── ac_test.go                 # [✓] 12个测试用例
├── options.go                 # 配置选项实现
├── benchmark_test.go          # [✓] 5个基准测试
└── testPlan.md                # 测试计划书（原始文档）
```

### 2.2 测试文件命名规范

所有测试文件遵循 Go 语言标准命名约定：
- **单元测试文件**: `{module}_test.go`
- **基准测试文件**: `benchmark_test.go`
- **集成测试文件**: `integration/*_test.go`（预留）

### 2.3 测试用例命名规范

测试函数采用 `Test{功能描述}` 格式：
```go
func TestNewPNCounter(t *testing.T)          // 构造函数测试
func TestIncrement(t *testing.T)             // 方法测试
func TestMerge_Concurrent(t *testing.T)      // 并发测试
func TestHistory_MaxSize(t *testing.T)       // 边界条件测试
```

---

## 3. 核心模块测试详解

### 3.1 store/pn_counter_test.go

**测试目标**: 验证 CRDT PN-Counter 的正确性

**关键测试用例**:
| 用例 | 名称 | 验证点 |
|------|------|--------|
| TC-PNC-001 | TestNewPNCounter | 初始化状态正确性 |
| TC-PNC-002 | TestIncrement | 增加操作 |
| TC-PNC-003 | TestDecrement | 减少操作 |
| TC-PNC-004 | TestValueCalculation | 值计算公式 |
| TC-PNC-005 | TestMerge_BasicMerge | 基础合并 |
| TC-PNC-006 | TestMerge_MaxValueRule | CRDT Max 规则 |
| TC-PNC-007 | TestMerge_Concurrent | 并发合并安全性 |
| TC-PNC-012 | TestHistory_MaxSize | 历史记录限制 |

**覆盖率**: 98.4%

### 3.2 pi/inspector_test.go

**测试目标**: 验证不一致性比率 φ 的计算逻辑

**关键测试用例**:
| 用例 | 名称 | 验证点 |
|------|------|--------|
| TC-PI-001 | TestNewInspector | 初始化 |
| TC-PI-002 | TestStartStop | 生命周期管理 |
| TC-PI-003 | TestCheckInconsistency_BasicPhi | 基础 φ 计算 |
| TC-PI-004 | TestCheckInconsistency_InsufficientHistory | 历史不足处理 |
| TC-PI-006 | TestReconstructTimelines | 时间线重构算法 |
| TC-PI-007 | TestCalculateCost | 成本计算（标准差） |

**覆盖率**: 97.1%

### 3.3 其他模块测试概览

| 模块 | 测试文件 | 用例数 | 覆盖率 | 主要验证点 |
|------|----------|--------|--------|------------|
| Dispatcher | dispatcher_test.go | 12 | ~80% | 准入控制、队列管理 |
| OCA Controller | controller_test.go | 13 | ~80% | PID算法、CL调整 |
| Transport | grpc_test.go | 12 | ~75% | gRPC通信、连接管理 |
| Manager | ac_test.go | 12 | ~80% | 核心API、组件集成 |

---

## 4. 测试执行指南

### 4.1 基本测试命令

```bash
# 运行所有测试（推荐日常开发使用）
go test -v ./...

# 运行特定模块测试
go test -v ./store/...
go test -v ./pi/...
go test -v ./dispatcher/...
go test -v ./oca/...
go test -v ./transport/...

# 快速测试（不显示详细输出）
go test ./...
```

### 4.2 覆盖率测试

```bash
# 生成覆盖率报告
go test -cover ./...

# 详细覆盖率报告（推荐代码审查时使用）
go test -v -coverprofile=coverage.out ./...
go tool cover -html=coverage.out -o coverage.html

# 查看函数级覆盖率
go tool cover -func=coverage.out
```

### 4.3 性能基准测试

```bash
# 运行所有基准测试
go test -bench=. -benchmem ./...

# 运行特定基准测试
go test -bench=BenchmarkUpdate -benchmem ./...

# 并发基准测试
go test -bench=BenchmarkConcurrentUpdates -benchmem ./...
```

### 4.4 竞态检测

```bash
# 检测数据竞争（重要：发布前必做）
go test -race ./...

# 结合覆盖率进行竞态检测
go test -race -cover ./...
```

### 4.5 集成测试（预留）

```bash
# 运行集成测试（需单独标记）
go test -v -tags=integration ./integration/...
```

---

## 5. 测试代码使用说明

### 5.1 编写新测试用例

**模板示例**:
```go
func Test{功能名称}(t *testing.T) {
    // 1. 准备测试数据
    obj := NewObject()
    
    // 2. 执行被测操作
    result := obj.Method(input)
    
    // 3. 验证结果
    if result != expected {
        t.Errorf("Expected %v, got %v", expected, result)
    }
}
```

**最佳实践**:
1. **单一职责**: 每个测试用例只验证一个功能点
2. **清晰命名**: 测试名称应明确表达测试意图
3. **完整验证**: 包含正常路径、边界条件、异常情况
4. **独立性**: 测试之间不应有依赖关系

### 5.2 并发测试编写

```go
func TestConcurrentAccess(t *testing.T) {
    obj := NewObject()
    var wg sync.WaitGroup
    
    // 启动多个 goroutine
    for i := 0; i < 100; i++ {
        wg.Add(1)
        go func(id int) {
            defer wg.Done()
            obj.ConcurrentMethod(id)
        }(i)
    }
    
    wg.Wait()
    
    // 验证最终状态
    if !obj.IsValid() {
        t.Error("Concurrent access caused invalid state")
    }
}
```

### 5.3 Mock 对象使用

对于需要外部依赖的测试，可使用 Mock：

```go
// 示例：Mock gRPC 客户端
type MockGRPCClient struct {
    CallCount int
    ShouldFail bool
}

func (m *MockGRPCClient) Send(data interface{}) error {
    m.CallCount++
    if m.ShouldFail {
        return errors.New("mock error")
    }
    return nil
}
```

---

## 6. 测试维护指南

### 6.1 新增功能时的测试流程

1. **分析影响范围**: 确定新增功能涉及哪些模块
2. **补充测试用例**: 按照测试计划书添加相应测试
3. **验证覆盖率**: 确保新增代码达到覆盖率要求
4. **回归测试**: 运行全套测试确保无破坏性变更

### 6.2 测试代码重构原则

- **保持测试语义**: 重构不应改变测试的验证意图
- **提高可读性**: 简化复杂的测试逻辑
- **消除重复**: 提取公共测试逻辑为辅助函数
- **更新文档**: 同步更新测试计划书

### 6.3 常见问题处理

**Q1: 测试偶尔失败怎么办？**
- 检查是否存在竞态条件
- 增加适当的等待时间或重试机制
- 使用 `testing.T.Parallel()` 进行并行测试隔离

**Q2: 覆盖率不达标如何处理？**
- 识别未覆盖的代码路径
- 补充边界条件和异常场景测试
- 考虑是否为不可达代码，可适当排除

**Q3: 性能测试结果波动大怎么办？**
- 在稳定环境下运行测试
- 多次运行取平均值
- 排除其他程序干扰

---

## 7. 性能基准参考

### 7.1 当前基准测试结果（示例）

```
BenchmarkUpdate-8            500000    2000 ns/op    128 B/op    2 allocs/op
BenchmarkGet-8              10000000     100 ns/op      0 B/op    0 allocs/op
BenchmarkSnapshot-8          100000   10000 ns/op   5120 B/op  100 allocs/op
BenchmarkConcurrentUpdates-8 200000    5000 ns/op    256 B/op    4 allocs/op
```

### 7.2 性能优化建议

1. **减少内存分配**: 复用对象，避免频繁创建
2. **优化锁竞争**: 使用更细粒度的锁或无锁数据结构
3. **批处理操作**: 合并多个小操作为单次大操作
4. **缓存热点数据**: 对频繁访问的数据进行缓存

---

## 8. CI/CD 集成建议

### 8.1 GitHub Actions 配置示例

```yaml
# .github/workflows/test.yml
name: Test Suite

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'
      
      - name: Run Unit Tests
        run: go test -v -race -coverprofile=coverage.out ./...
      
      - name: Check Coverage Threshold
        run: |
          COVERAGE=$(go tool cover -func=coverage.out | grep total | awk '{print $3}' | sed 's/%//')
          if (( $(echo "$COVERAGE < 80" | bc -l) )); then
            echo "Coverage $COVERAGE% is below threshold 80%"
            exit 1
          fi
      
      - name: Run Benchmarks
        run: go test -bench=. -benchmem ./...
```

### 8.2 本地开发环境配置

建议在开发环境中配置以下别名：

```bash
# 添加到 ~/.bashrc 或 ~/.zshrc
alias gotest='go test -v ./...'
alias gocover='go test -coverprofile=coverage.out ./... && go tool cover -html=coverage.out'
alias gobench='go test -bench=. -benchmem ./...'
alias gorace='go test -race ./...'
```

---

## 9. 附录

### 9.1 测试工具推荐

| 工具 | 用途 | 安装命令 |
|------|------|----------|
| `go test` | 标准测试工具 | 内置 |
| `go tool cover` | 覆盖率分析 | 内置 |
| `go tool vet` | 代码静态分析 | 内置 |
| `golangci-lint` | 代码质量检查 | `go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest` |
| `benchstat` | 基准测试结果分析 | `go install golang.org/x/perf/cmd/benchstat@latest` |

### 9.2 常用测试模式

1. **Table Driven Tests**: 使用表格驱动的方式测试多种输入组合
2. **Subtests**: 使用 `t.Run()` 组织子测试
3. **Fuzzing**: Go 1.18+ 支持模糊测试
4. **Property Based Testing**: 使用 `gopter` 等库进行属性测试

### 9.3 版本更新记录

| 版本 | 日期 | 更新内容 |
|------|------|----------|
| v1.0.0 | 2026-02-07 | 初始版本，完成核心模块测试 |

---

**文档维护人**: 开发团队  
**最后更新**: 2026-02-07  
**联系方式**: [项目GitHub Issues](https://github.com/weufhsos/adaptive_sync_go/issues)
