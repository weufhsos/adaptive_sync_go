# Go-SDN AC 仿真验证环境项目实现书

## 1. 系统架构概述

### 1.1 三层架构设计

```
┌─────────────────────────────────────────────────────────────┐
│                    北向 - 负载生成层                          │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │
│  │ LoadGen-1   │  │ LoadGen-2   │  │  Metrics    │          │
│  │ (请求生成器) │  │ (批量测试)  │  │ (Prometheus)│          │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘          │
└─────────┼────────────────┼────────────────┼─────────────────┘
          │                │                │
          ▼                ▼                ▼
┌─────────────────────────────────────────────────────────────┐
│                 控制平面层 - mock-SDN 集群                    │
│                                                              │
│     ┌────────┐     ┌────────┐     ┌────────┐                │
│     │ SDN-1  │◄───►│ SDN-2  │◄───►│ SDN-3  │                │
│     │ (AC)   │     │ (AC)   │     │ (AC)   │                │
│     └───┬────┘     └───┬────┘     └───┬────┘                │
│         │   ╲       ╱  │  ╲       ╱   │                     │
│         │    ╲     ╱   │   ╲     ╱    │                     │
│         │     ╲   ╱    │    ╲   ╱     │                     │
│     ┌───┴────┐  ╳      │     ╳   ┌───┴────┐                 │
│     │ SDN-4  │◄─╱─╲────┴────╱─╲─►│ SDN-5  │                 │
│     │ (AC)   │◄─────────────────►│ (AC)   │                 │
│     └───┬────┘                   └───┬────┘                 │
│         │      (全连接网状拓扑)       │                      │
└─────────┼────────────────────────────┼──────────────────────┘
          │                            │
          ▼                            ▼
┌─────────────────────────────────────────────────────────────┐
│                 南向 - 基础设施层                            │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │
│  │   Redis     │  │  Grafana    │  │ InfluxDB    │          │
│  │ (状态共享)  │  │ (可视化)    │  │ (时序数据)  │          │
│  └─────────────┘  └─────────────┘  └─────────────┘          │
└─────────────────────────────────────────────────────────────┘
```

### 1.2 核心组件说明

| 层级 | 组件 | 职责 |
|------|------|------|
| 北向 | LoadGen | 生成带宽分配请求，模拟用户流量 |
| 北向 | Prometheus | 收集各节点指标 |
| 控制平面 | mock-SDN x5 | 集成AC协调层的SDN控制器 |
| 南向 | Redis | 可选的外部状态共享（对比实验用） |
| 南向 | InfluxDB | 存储时序指标数据 |
| 南向 | Grafana | 实时可视化仪表板 |

---

## 2. 目录结构设计

```
f:/article_resee/adaptive_sync_go/
simulation/
├── .env                           # 环境变量配置
├── docker-compose.yml             # Docker编排配置 (5个SDN节点 + 监控)
├── mock-sdn/                      # mock-SDN控制器
│   ├── main.go                    # 入口
│   ├── go.mod / go.sum            # 模块依赖
│   ├── Dockerfile                 # 容器镜像
│   ├── controller/
│   │   ├── controller.go          # SDN控制器核心（集成AC）
│   │   └── link_manager.go        # 链路管理器
│   ├── simulator/
│   │   └── network_sim.go         # 网络模拟器
│   ├── api/
│   │   └── http_server.go         # HTTP API服务
│   └── metrics/
│       └── exporter.go            # Prometheus指标导出
├── loadgen/                       # 负载生成器
│   ├── main.go                    # 入口
│   ├── go.mod / go.sum            # 模块依赖
│   ├── Dockerfile                 # 容器镜像
│   ├── generator/
│   │   └── request_gen.go         # 请求生成器
│   └── config/
│       └── scenarios.yaml         # 测试场景配置
├── monitoring/                    # 监控配置
│   ├── prometheus/
│   │   └── prometheus.yml         # Prometheus配置
│   └── grafana/
│       ├── provisioning/          # 自动配置
│       └── dashboards/
│           └── sdn-dashboard.json # 仪表板
└── scripts/                       # 辅助脚本
    ├── start.sh                   # 启动脚本
    ├── stop.sh                    # 停止脚本
    └── run_experiment.sh          # 实验运行脚本
```

---

## 3. 核心组件设计

### 3.1 mock-SDN 控制器

#### 3.1.1 控制器核心 (`mock-sdn/controller/controller.go`)

```go
// SDNController mock-SDN控制器，集成AC协调层
type SDNController struct {
    nodeID      string
    acManager   *ac.Manager           // AC协调层
    linkManager *LinkManager          // 链路管理器
    simulator   *simulator.NetworkSim // 网络模拟器
    httpServer  *api.Server           // HTTP API
    metrics     *metrics.Exporter     // 指标导出
}

// 核心方法
func (c *SDNController) Start() error
func (c *SDNController) Stop() error
func (c *SDNController) AllocateBandwidth(linkID string, amount float64) error
func (c *SDNController) ReleaseBandwidth(linkID string, amount float64) error
func (c *SDNController) GetBestLink() (string, float64, error)
```

#### 3.1.2 链路管理器 (`mock-sdn/controller/link_manager.go`)

```go
// LinkManager 管理本地链路状态
type LinkManager struct {
    links       map[string]*Link      // 链路映射
    acManager   *ac.Manager           // AC协调层引用
    mu          sync.RWMutex
}

// Link 链路模型
type Link struct {
    ID           string
    Capacity     float64  // 总容量 (Mbps)
    Allocated    float64  // 已分配 (通过AC获取)
    Latency      float64  // 延迟 (ms)
    TargetNodeID string   // 目标节点
}

// 核心方法
func (lm *LinkManager) GetAvailableBandwidth(linkID string) float64
func (lm *LinkManager) SelectBestLink() (*Link, error)
func (lm *LinkManager) UpdateFromAC()  // 从AC同步状态
```

#### 3.1.3 网络模拟器 (`mock-sdn/simulator/network_sim.go`)

```go
// NetworkSim 网络状态模拟器
type NetworkSim struct {
    links           map[string]*LinkState
    noiseLevel      float64           // 噪声级别
    updateInterval  time.Duration     // 更新间隔
    stopChan        chan struct{}
}

// 模拟策略
type SimulationStrategy interface {
    GenerateUpdate(link *LinkState) float64
}

// 实现的策略
// - RandomWalkStrategy: 随机游走
// - BurstStrategy: 突发流量
// - PeriodicStrategy: 周期性波动
```

### 3.2 负载生成器

#### 3.2.1 请求生成器 (`loadgen/generator/request_gen.go`)

```go
// RequestGenerator 请求生成器
type RequestGenerator struct {
    targetNodes []string          // 目标SDN节点
    pattern     TrafficPattern    // 流量模式
    rps         float64           // 每秒请求数
    duration    time.Duration     // 持续时间
}

// TrafficPattern 流量模式
type TrafficPattern interface {
    NextRequest() *BandwidthRequest
    NextDelay() time.Duration
}

// BandwidthRequest 带宽请求
type BandwidthRequest struct {
    RequestID   string
    Bandwidth   float64       // 请求带宽
    HoldTime    time.Duration // 持有时间
    TargetNode  string        // 目标节点
}
```

### 3.3 HTTP API 设计

| 端点 | 方法 | 描述 |
|------|------|------|
| `/api/v1/allocate` | POST | 请求带宽分配 |
| `/api/v1/release` | POST | 释放带宽 |
| `/api/v1/status` | GET | 获取控制器状态 |
| `/api/v1/links` | GET | 获取所有链路状态 |
| `/api/v1/links/{id}` | GET | 获取特定链路状态 |
| `/api/v1/metrics` | GET | Prometheus 指标 |
| `/api/v1/consistency` | GET | AC一致性指标 |

---

## 4. Docker Compose 编排

### 4.1 主配置 (`simulation/docker-compose.yml`)

```yaml
version: '3.8'

services:
  # ========== 控制平面层 ==========
  sdn-1:
    build: ./mock-sdn
    container_name: sdn-1
    environment:
      - NODE_ID=sdn-1
      - GRPC_PORT=50051
      - HTTP_PORT=8080
      - PEERS=sdn-2:50051,sdn-3:50051,sdn-4:50051,sdn-5:50051
      - TARGET_PHI=1.05
      - LINK_CAPACITY=1000
    ports:
      - "8081:8080"
      - "50051:50051"
    networks:
      - sdn-network
    depends_on:
      - influxdb

  sdn-2:
    build: ./mock-sdn
    container_name: sdn-2
    environment:
      - NODE_ID=sdn-2
      - GRPC_PORT=50051
      - HTTP_PORT=8080
      - PEERS=sdn-1:50051,sdn-3:50051,sdn-4:50051,sdn-5:50051
      - TARGET_PHI=1.05
      - LINK_CAPACITY=1000
    ports:
      - "8082:8080"
    networks:
      - sdn-network

  # sdn-3, sdn-4, sdn-5 类似配置...

  # ========== 北向负载层 ==========
  loadgen:
    build: ./loadgen
    container_name: loadgen
    environment:
      - TARGET_NODES=sdn-1:8080,sdn-2:8080,sdn-3:8080,sdn-4:8080,sdn-5:8080
      - RPS=100
      - DURATION=300s
      - PATTERN=poisson
    depends_on:
      - sdn-1
      - sdn-2
      - sdn-3
      - sdn-4
      - sdn-5
    networks:
      - sdn-network

  # ========== 南向基础设施层 ==========
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    volumes:
      - ./monitoring/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
    ports:
      - "9090:9090"
    networks:
      - sdn-network

  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    volumes:
      - ./monitoring/grafana/provisioning:/etc/grafana/provisioning
      - ./monitoring/grafana/dashboards:/var/lib/grafana/dashboards
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
    networks:
      - sdn-network

  influxdb:
    image: influxdb:2.7
    container_name: influxdb
    ports:
      - "8086:8086"
    environment:
      - DOCKER_INFLUXDB_INIT_MODE=setup
      - DOCKER_INFLUXDB_INIT_USERNAME=admin
      - DOCKER_INFLUXDB_INIT_PASSWORD=adminpass
      - DOCKER_INFLUXDB_INIT_ORG=sdn-sim
      - DOCKER_INFLUXDB_INIT_BUCKET=metrics
    networks:
      - sdn-network

networks:
  sdn-network:
    driver: bridge
```

---

## 5. 关键指标与监控

### 5.1 收集的指标

| 指标名称 | 类型 | 描述 |
|----------|------|------|
| `sdn_link_bandwidth_available` | Gauge | 链路可用带宽 |
| `sdn_link_bandwidth_allocated` | Gauge | 链路已分配带宽 |
| `sdn_request_total` | Counter | 请求总数 |
| `sdn_request_success` | Counter | 成功请求数 |
| `sdn_request_rejected` | Counter | 拒绝请求数 (带宽不足) |
| `sdn_request_latency_ms` | Histogram | 请求延迟分布 |
| `ac_phi_value` | Gauge | 当前φ值 |
| `ac_consistency_level_qs` | Gauge | 当前队列大小 |
| `ac_sync_latency_ms` | Histogram | 同步延迟 |
| `ac_conflicts_total` | Counter | 冲突次数 |

### 5.2 Grafana 仪表板

- **一致性面板**: φ值趋势、CL调整历史
- **负载面板**: 各链路带宽使用率、请求QPS
- **性能面板**: 请求延迟P50/P95/P99、冲突率
- **节点健康面板**: 各节点状态、同步延迟

---

## 6. 实验场景设计

### 6.1 场景1: 基准测试 (Baseline)
- **目的**: 测试AC协调层在正常负载下的表现
- **配置**: RPS=50, 均匀分布请求
- **时长**: 5分钟
- **观测**: φ值稳定性、请求成功率

### 6.2 场景2: 突发负载 (Burst)
- **目的**: 测试AC在突发流量下的自适应能力
- **配置**: 基础RPS=20, 每30秒突发到RPS=200
- **时长**: 10分钟
- **观测**: CL调整响应时间、冲突率变化

### 6.3 场景3: 网络分区 (Partition)
- **目的**: 测试部分节点不可达时的行为
- **配置**: 运行中断开sdn-3与其他节点的连接
- **时长**: 5分钟(分区) + 5分钟(恢复)
- **观测**: 分区期间的一致性、恢复后的收敛时间

### 6.4 场景4: 对比实验 (Comparison)
- **目的**: 对比有AC vs 无AC的效果
- **配置**: 分别运行两组实验
- **观测**: 冲突率、过度分配次数、响应延迟

---

## 7. 实现步骤

### Phase 1: 基础框架 (预计2-3天)
1. 创建 `simulation/` 目录结构
2. 实现 mock-SDN 控制器基础框架
3. 集成现有 AC 协调层
4. 实现基础 HTTP API

### Phase 2: 模拟器开发 (预计2天)
1. 实现网络模拟器核心逻辑
2. 实现多种流量模式策略
3. 实现链路管理器

### Phase 3: 负载生成器 (预计1天)
1. 实现请求生成器
2. 实现多种流量模式
3. 配置场景文件

### Phase 4: 容器化与编排 (预计1天)
1. 编写 Dockerfile
2. 编写 docker-compose.yml
3. 配置网络和环境变量

### Phase 5: 监控与可视化 (预计1天)
1. 配置 Prometheus
2. 创建 Grafana 仪表板
3. 集成 InfluxDB

### Phase 6: 实验执行 (预计2天)
1. 运行基准测试
2. 运行压力测试
3. 收集和分析数据

---

## 8. 预期验证目标

| 验证项 | 预期结果 |
|--------|----------|
| φ值稳定性 | 正常负载下φ维持在1.0-1.1范围 |
| 自适应响应 | 负载变化后CL在3-5秒内完成调整 |
| 冲突率 | 对比无AC方案，冲突率降低50%+ |
| 过度分配 | 带宽过度分配事件 < 1% |
| 最终一致性 | 网络分区恢复后5秒内达到一致 |